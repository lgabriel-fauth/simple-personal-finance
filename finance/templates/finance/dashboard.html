{% extends 'finance/base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<h1 class="h3 mb-4">Dashboard</h1>

<h2 class="h5 mb-3">⚠️ Alertas de Vencimento (próximos 7 dias)</h2>
{% if upcoming_invoices %}
<div class="alert alert-warning border-warning mb-4">
  <div class="table-responsive">
    <table class="table table-sm table-hover mb-0">
      <thead class="table-warning">
        <tr>
          <th>Fatura</th>
          <th>Vencimento</th>
          <th>Status</th>
          <th class="text-end">Valor</th>
          <th class="text-end">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for inv in upcoming_invoices %}
        <tr>
          <td><strong>{{ inv.card.name }}</strong> {{ inv.year }}-{{ inv.month|stringformat:"02d" }}</td>
          <td>
            <span class="badge {% if inv.due_date <= today %}bg-danger{% else %}bg-warning text-dark{% endif %}">
              {{ inv.due_date|date:"d/m/Y" }}
            </span>
          </td>
          <td>
            <span class="badge 
              {% if inv.status == 'OPEN' %}bg-primary
              {% elif inv.status == 'CLOSED' %}bg-warning text-dark
              {% elif inv.status == 'PARTIAL' %}bg-info
              {% else %}bg-success{% endif %}">
              {{ inv.get_status_display }}
            </span>
          </td>
          <td class="text-end">
            <strong>R$ {{ inv.balance|floatformat:2 }}</strong>
          </td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-primary" href="{% url 'finance:invoice_detail' inv.pk %}">Ver Detalhes</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div class="alert alert-success mb-4">
  <i class="bi bi-check-circle"></i> Sem alertas de vencimento nos próximos 7 dias.
</div>
{% endif %}

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h2 class="h5 mb-3">Resumo do Mês</h2>
    <div class="row g-3 align-items-center">
      <div class="col-md-3">
        <div class="small text-muted">Entradas do mês</div>
        <div class="fs-5 fw-bold text-success">R$ {{ month_income_total|floatformat:2 }}</div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted">Saídas do mês</div>
        <div class="fs-5 fw-bold text-danger">R$ {{ month_outcome_total|floatformat:2 }}</div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted">Faturas a pagar ({{ month_start|date:"d/m" }}–{{ month_end|date:"d/m" }})</div>
        <div class="fs-5 fw-bold text-danger">R$ {{ invoices_to_pay_total|floatformat:2 }}</div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted">Sobra após faturas</div>
        <div class="fs-5 fw-bold {% if remaining_after_bills >= 0 %}text-success{% else %}text-danger{% endif %}">R$ {{ remaining_after_bills|floatformat:2 }}</div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted">Dias restantes no mês</div>
        <div class="fs-5 fw-bold">{{ days_left_in_month }}</div>
      </div>
    </div>
    <div class="mt-3 pt-3 border-top">
      <div class="small text-muted mb-1">Média possível por dia até o fim do mês</div>
      <div class="fs-4 fw-bold {% if per_day_allowance >= 0 %}text-success{% else %}text-danger{% endif %}">R$ {{ per_day_allowance|floatformat:2 }}</div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h2 class="h5 mb-3">Resumo do Próx Mês</h2>
    <div class="row g-3 align-items-center">
      <div class="col-md-3">
        <div class="small text-muted">Entradas ({{ next_month_start|date:"d/m" }}–{{ next_month_end|date:"d/m" }})</div>
        <div class="fs-5 fw-bold text-success">R$ {{ next_month_income_total|floatformat:2 }}</div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted">Saídas ({{ next_month_start|date:"d/m" }}–{{ next_month_end|date:"d/m" }})</div>
        <div class="fs-5 fw-bold text-danger">R$ {{ next_month_outcome_total|floatformat:2 }}</div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted">Faturas a pagar</div>
        <div class="fs-5 fw-bold text-danger">R$ {{ invoices_to_pay_total_next|floatformat:2 }}</div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted">Sobra após faturas</div>
        <div class="fs-5 fw-bold {% if remaining_after_bills_next >= 0 %}text-success{% else %}text-danger{% endif %}">
          R$ {{ remaining_after_bills_next|floatformat:2 }}
        </div>
      </div>
    </div>
  </div>
</div>

<h2 class="h5">Saldos por Conta</h2>
<div class="row g-3 mb-4">
  {% for item in account_balances %}
  <div class="col-md-4">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h6 class="card-title mb-3">
          <span class="badge bg-secondary me-2">{{ item.account.get_type_display }}</span>
          {{ item.account.name }}
        </h6>
        <div class="mb-3">
          <div class="small text-muted">Saldo Atual</div>
          <div class="fs-3 fw-bold {% if item.balance >= 0 %}text-success{% else %}text-danger{% endif %}">
            R$ {{ item.balance|floatformat:2 }}
          </div>
        </div>
        <div class="row g-2 mb-2">
          <div class="col-6">
            <div class="small text-muted">Entradas</div>
            <div class="fw-bold text-success">R$ {{ item.total_income|floatformat:2 }}</div>
          </div>
          <div class="col-6">
            <div class="small text-muted">Saídas</div>
            <div class="fw-bold text-danger">R$ {{ item.total_outcome|floatformat:2 }}</div>
          </div>
        </div>
        <div class="mt-2 pt-2 border-top">
          <div class="small text-muted mb-1">Este mês ({{ month_start|date:"M/Y" }})</div>
          <div class="row g-2">
            <div class="col-6">
              <div class="small text-muted">Entradas</div>
              <div class="small fw-bold text-success">R$ {{ item.month_income|floatformat:2 }}</div>
            </div>
            <div class="col-6">
              <div class="small text-muted">Saídas</div>
              <div class="small fw-bold text-danger">R$ {{ item.month_outcome|floatformat:2 }}</div>
            </div>
          </div>
        </div>
        <div class="mt-2 pt-2 border-top">
          <div class="small text-muted">Saldo Inicial: <strong>R$ {{ item.initial_balance|floatformat:2 }}</strong></div>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="col-12">
    <div class="alert alert-info">Sem contas cadastradas.</div>
  </div>
  {% endfor %}
</div>

<h2 class="h5">Totais de Faturas por Cartão</h2>
<div class="row g-3 mb-4">
  {% for item in card_invoice_totals %}
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="card-title">{{ item.card.name }}</h6>
        <div class="small text-muted mb-2">Saldo: <strong class="text-dark">R$ {{ item.balance|floatformat:2 }}</strong></div>
        <div class="row g-2">
          <div class="col-6">
            <div class="small text-muted">Abertas</div>
            <div class="fw-bold text-primary">R$ {{ item.open_total|floatformat:2 }}</div>
          </div>
          <div class="col-6">
            <div class="small text-muted">Fechadas</div>
            <div class="fw-bold text-warning">R$ {{ item.closed_total|floatformat:2 }}</div>
          </div>
          <div class="col-6">
            <div class="small text-muted">Parciais</div>
            <div class="fw-bold text-info">R$ {{ item.partial_total|floatformat:2 }}</div>
          </div>
          <div class="col-6">
            <div class="small text-muted">Pagas</div>
            <div class="fw-bold text-success">R$ {{ item.paid_total|floatformat:2 }}</div>
          </div>
        </div>
        <div class="mt-2 pt-2 border-top">
          <div class="small text-muted">Total Compras: <strong>R$ {{ item.total_charges|floatformat:2 }}</strong></div>
          <div class="small text-muted">Total Pagamentos: <strong>R$ {{ item.total_payments|floatformat:2 }}</strong></div>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="col-12">Sem cartões cadastrados.</div>
  {% endfor %}
</div>

<h2 class="h5">Despesas por Categoria - Contas ({{ month_start|date:"d/m/Y" }} a {{ month_end|date:"d/m/Y" }})</h2>
{% if expenses_by_category_account %}
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Categoria</th>
            <th class="text-end">Valor</th>
            <th class="text-end" style="width: 200px;">Percentual</th>
          </tr>
        </thead>
        <tbody>
          {% for cat, val in expenses_by_category_account.items %}
          <tr>
            <td>
              <span class="badge bg-secondary me-2">{{ forloop.counter }}</span>
              {{ cat }}
            </td>
            <td class="text-end fw-bold">R$ {{ val|floatformat:2 }}</td>
            <td class="text-end">
              <div class="progress" style="height: 20px;">
                {% if expenses_total_account > 0 %}
                <div class="progress-bar bg-danger" role="progressbar" 
                     style="width: {% widthratio val expenses_total_account 100 %}%"
                     aria-valuenow="{% widthratio val expenses_total_account 100 %}" 
                     aria-valuemin="0" aria-valuemax="100">
                  {% widthratio val expenses_total_account 100 %}%
                </div>
                {% else %}
                <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%">0%</div>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
          <tr class="table-info fw-bold">
            <td>Total</td>
            <td class="text-end">R$ {{ expenses_total_account|floatformat:2 }}</td>
            <td class="text-end">100%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
{% else %}
<div class="alert alert-info mb-4">Sem despesas em contas no período.</div>
{% endif %}

<h2 class="h5">Despesas por Categoria - Cartão ({{ month_start|date:"d/m/Y" }} a {{ month_end|date:"d/m/Y" }})</h2>
{% if expenses_by_category_card %}
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Categoria</th>
            <th class="text-end">Valor</th>
            <th class="text-end" style="width: 200px;">Percentual</th>
          </tr>
        </thead>
        <tbody>
          {% for cat, val in expenses_by_category_card.items %}
          <tr>
            <td>
              <span class="badge bg-primary me-2">{{ forloop.counter }}</span>
              {{ cat }}
            </td>
            <td class="text-end fw-bold">R$ {{ val|floatformat:2 }}</td>
            <td class="text-end">
              <div class="progress" style="height: 20px;">
                {% if expenses_total_card > 0 %}
                <div class="progress-bar bg-warning" role="progressbar" 
                     style="width: {% widthratio val expenses_total_card 100 %}%"
                     aria-valuenow="{% widthratio val expenses_total_card 100 %}" 
                     aria-valuemin="0" aria-valuemax="100">
                  {% widthratio val expenses_total_card 100 %}%
                </div>
                {% else %}
                <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%">0%</div>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
          <tr class="table-warning fw-bold">
            <td>Total</td>
            <td class="text-end">R$ {{ expenses_total_card|floatformat:2 }}</td>
            <td class="text-end">100%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
{% else %}
<div class="alert alert-info mb-4">Sem despesas em cartão no período.</div>
{% endif %}
{% endblock %}